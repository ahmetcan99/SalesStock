@model SalesStock.Application.Features.PriceLists.DTOs.ManagePriceListItemsDTO
@{
    ViewData["Title"] = "Manage Items for " + Model.PriceListName;
}

<div class="card max-w-7xl mx-auto">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert-success mb-4" role="alert"><span>@TempData["SuccessMessage"]</span></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert-error mb-4" role="alert"><span>@TempData["ErrorMessage"]</span></div>
    }

    <div class="flex items-center mb-6 mx-4">
        <h1 class="card-header mr-auto my-auto">@ViewData["Title"]</h1>
        <a asp-action="Index" class="btn btn-neutral">Back to Price Lists</a>
    </div>
    <div class="card">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">Add New Item</h2>
        <form asp-action="AddItem" method="post" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
            <input type="hidden" asp-for="NewItem.PriceListId" />
            <input type="hidden" asp-for="PriceListId" />

            <div class="md:col-span-2">
                <label asp-for="NewItem.ProductId" class="form-label">Product (SKU)</label>
                <select asp-for="NewItem.ProductId" id="select-product-sku" placeholder="Search for a product..."></select>
            </div>
            <div>
                <label asp-for="NewItem.Price" class="form-label"></label>
                <input asp-for="NewItem.Price" class="form-input" />
            </div>
            <div>
                <label asp-for="NewItem.ValidFrom" class="form-label"></label>
                <input asp-for="NewItem.ValidFrom" type="date" class="input-date" />
            </div>
            <div>
                <label asp-for="NewItem.ValidTo" class="form-label"></label>
                <input asp-for="NewItem.ValidTo" type="date" class="input-date"/>
            </div>
            <button type="submit" class="btn btn-primary">Add Item</button>
        </form>
    </div>
    <div class="overflow-x-auto rounded-lg shadow-sm">
        <table class="table-default">
            <thead class="table-head">
                <tr>
                    <th>SKU</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Valid From</th>
                    <th>Valid To</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.SKU</td>
                        <td>@item.ProductName</td>
                        <td>@item.Price.ToString("C")</td>
                        <td>@item.ValidFrom.ToString("yyyy-MM-dd")</td>
                        <td>@item.ValidTo.ToString("yyyy-MM-dd")</td>
                        <td>
                            <form asp-action="RemoveItem" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Are you sure you want to remove this item?');">
                                <input type="hidden" name="priceListId" value="@Model.PriceListId" />
                                <button type="submit" class="btn btn-danger text-sm">Remove</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        fetch('/PriceLists/SearchAvailableProducts')
            .then(r => r.json())
            .then(initialOptions => {
                new TomSelect('#select-product-sku', {
                    options: initialOptions,
                    valueField: 'value',
                    labelField: 'text',
                    searchField: ['text'],
                    openOnFocus: true,
                    preload: 'focus',
                    shouldLoad: function () { return true; },
                    load: function (query, callback) {
                        const url = '/PriceLists/SearchAvailableProducts?term=' + encodeURIComponent(query || '');
                        fetch(url)
                            .then(res => res.json())
                            .then(data => callback(data))
                            .catch(() => callback());
                    },
                    render: {
                        loading: function () { return '<div class="p-2">Loading…</div>'; },
                        option: function (item, escape) { return `<div>${escape(item.text)}</div>`; },
                        no_results: function () { return '<div class="p-2">No products found.</div>'; }
                    }
                });
            });
        });
    </script>
}